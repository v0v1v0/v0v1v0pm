<div class="container">

<table style="width: 100%;"><tr>
<td>trait-simulator</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Simulate the Evolution of a Quantitative Trait</h2>

<h3>Description</h3>

<p>Functions to simulate the evolution of a quantitative trait
along a phylogenetic tree inputted as an object of class ‘phylo’
(package ape) or a <code>graph-class</code> object.
</p>


<h3>Usage</h3>

<pre><code class="language-R">EvolveOptimMarkovTree(tp, tw, anc, p = 1, root = tp$edge[1, 1])

TraitOUsimTree(tp, a, sigma, opt, p = 1, root = tp$edge[1, 1])

OUvar(d, a = 0, theta = 1, sigma = 1)

PEMvar(d, a = 0, psi = 1)

TraitVarGraphSim(x, variance, distance = "distance", p = 1, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>tp</code></td>
<td>
<p>A rooted phylogenetic tree of class ‘phylo’ (see package
ape).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tw</code></td>
<td>
<p>Transition matrix giving the probability that the optimum trait
value changes from one state (row) to another (column) at vertices. 
All rows must sum to 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>anc</code></td>
<td>
<p>Ancestral state of a trait (at the root).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p</code></td>
<td>
<p>Number of variates to generate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>root</code></td>
<td>
<p>Root node of the tree.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>a</code></td>
<td>
<p>Selection rate in function (<code>OUvar</code>) or steepness in
(<code>PEMvar</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sigma</code></td>
<td>
<p>Neutral evolution rate, i.e. mean trait shift by drift.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>opt</code></td>
<td>
<p>An index vector of optima at the nodes.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d</code></td>
<td>
<p>Phylogenetic distances (edge lengths).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>theta</code></td>
<td>
<p>Adaptive evolution rate, i.e. mean trait shift by natural
selection.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>psi</code></td>
<td>
<p>Mean evolution rate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>A <code>graph-class</code> object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>variance</code></td>
<td>
<p>Variance function: <code>OUvar</code>, <code>PEMvar</code>,
or any other suitable user-defined function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>distance</code></td>
<td>
<p>The name of the member of ‘x$edge’ where edge lengths
can be found.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Additional parameters for the specified variance function.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Function <code>EvolveOptimMarkovTree</code> allows one to simulate the
changes of optimum trait values as a Markov process. The index whereby the
process starts, at the tree root, is set by parameter <code>anc</code>; this is the
ancestral character state. From the root onwards to the tips, the optimum is
given the opportunity to change following a multinomial random draw with
transition probabilities given by the rows of matrix <code>tw</code>. The integers
thus obtained can be used as indices of a vector featuring the actual optimum
trait values corresponding to the simulated selection regimes. 
</p>
<p>The resulting
optimum trait values at the nodes are used by <code>TraitOUsimTree</code> as
its argument <code>opt</code> to simulate trait values at nodes and tips.
</p>
<p>Function <code>TraitVarGraphSim</code> uses a graph variance function
(either <code>OUvar</code> or <code>PEMvar</code>) to reconstruct a covariance matrix,
used to generate covariates drawn from a multi-normal distribution.
</p>


<h3>Value</h3>

<p>Functions <code>EvolveOptimMarkovTree</code> and
<code>TraitOUsimTree</code> return a matrix whose rows represent the
vertices (nodes and tips) of the phylogenetic tree and whose columns stand
for the <code>n</code> different trials the function was asked to perform. 
</p>
<p>For <code>EvolveQTraitTree</code>, the elements of the matrix are integers,
representing the selection regimes prevailing at the nodes and tips, whereas
for <code>TraitOUsimTree</code>, the elements are simulated quantitative
trait values at the nodes and tips. These functions are implemented in C
language and therefore run swiftly even for large (10000+ species) trees.
</p>
<p>Function <code>TraitVarGraphSim</code> returns <code>p</code> phylogenetic signals.
It is implemented using a rotation of a matrix of standard normal random
(mean=0, variance=1) deviates. The rotation matrix is itself obtained by
Choleski factorization of the trait covariance matrix expected for a given
set of trees, variance function, and variance function parameters.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>EvolveOptimMarkovTree()</code>: Trait Optima Simulator
</p>
<p>Simulates the evolution of trait optima along a phylogeny as a Markov
process.
</p>
</li>
<li> <p><code>TraitOUsimTree()</code>: Trait Value Simulator
</p>
<p>Simulates the evolution of trait values along a phylogeny as a
Ornstein–Uhlenbeck process.
</p>
</li>
<li> <p><code>OUvar()</code>: Ornstein–Uhlenbeck Variance Calculator
</p>
<p>Calculates the expected covariance matrix for a trait evolving following an
Ornstein–Uhlenbeck process. This function is meant to be used with function
<code>TraitVarGraphSim</code>.
</p>
</li>
<li> <p><code>PEMvar()</code>: Phylogenetic Eigenvector Maps Variance Calculator
</p>
<p>Calculates the covariance on the basis of the covariance model (power
function) associated used in calculating Phylogenetic Eigenvector Maps. This
function is meant to be used with function <code>TraitVarGraphSim</code>.
</p>
</li>
<li> <p><code>TraitVarGraphSim()</code>: Covariance-based Trait Evolution Simulator.
</p>
<p>Simulates trait evolution as covariates drawn from a multi-normal
distribution whose covariance is estimated using an external function
(functions <code>OUvar</code>, <code>PEMvar</code> provided with the package or any
user-provided function).
</p>
</li>
</ul>
<h3>Author(s)</h3>

<p>Guillaume Guénard [aut, cre] (&lt;https://orcid.org/0000-0003-0761-3072&gt;),
  Pierre Legendre [ctb] (&lt;https://orcid.org/0000-0002-3838-3305&gt;)
Maintainer: Guillaume Guénard &lt;guillaume.guenard@umontreal.ca&gt;
</p>


<h3>References</h3>

<p>Butler, M. A. &amp; King, A. A. 2004. Phylogenetic comparative analysis: a
modeling approach for adaptive evolution. American Naturalist 164: 683-695
</p>
<p>Guénard, G., Legendre, P., and Peres-Neto, P. 2013. Phylogenetic eigenvector
maps: a framework to model and predict species traits.  Methods in Ecology 
and Evolution 4: 1120-1131
</p>


<h3>Examples</h3>

<pre><code class="language-R">opt &lt;- c(-2,0,2) # Three trait optima: -2, 0, and 2
## Transition probabilities:
transit &lt;- matrix(c(0.7,0.2,0.2,0.2,0.7,0.1,0.1,0.1,0.7),
                  length(opt),length(opt),dimnames=list(from=opt,to=opt))

## In this example, the trait has a probability of 0.7 to stay at a given
## optimum, a probability of 0.2 for the optimum to change from -2 to 0,
## from 0 to -2, and from 2 to -2, and a probability of 0.1 for the
## optimum to change from -2 to 2, from 0 to 2, and from 2 to 0.
nsp &lt;- 25  # A random tree for 25 species.
tree2 &lt;- rtree(nsp,tip.label=paste("Species",1:nsp,sep=""))
tree2$node.label=paste("N",1:tree2$Nnode,sep="")  # Node labels.

## Simulate 10 trials of optimum change.
reg &lt;- EvolveOptimMarkovTree(tp=tree2,tw=transit,p=10,anc=2)
y1 &lt;- TraitOUsimTree(tp=tree2,a=0,sigma=1,
                     opt=opt[reg[,1]],p=10)    ## Neutral
y2 &lt;- TraitOUsimTree(tp=tree2,a=1,sigma=1,
                     opt=opt[reg[,1]],p=10)    ## Few selection.
y3 &lt;- TraitOUsimTree(tp=tree2,a=10,sigma=1,
                     opt=opt[reg[,1]],p=10)    ## Strong selection.

## Display optimum change with colours.
displayOUprocess &lt;- function(tp,trait,regime,mvalue) {
  layout(matrix(1:2,1,2))
  n &lt;- length(tp$tip.label)
  ape::plot.phylo(tp,show.tip.label=TRUE,show.node.label=TRUE,root.edge=FALSE,
                  direction="rightwards",adj=0,
                  edge.color=rainbow(length(trait))[regime[tp$edge[,2]]])
  plot(y=1:n,x=mvalue[1:n],type="b",xlim=c(-5,5),ylab="",xlab="Trait value",yaxt="n",
       bg=rainbow(length(trait))[regime[1:n]],pch=21) 
  text(trait[regime[1:n]],y=1:n,x=5,col=rainbow(length(trait))[regime[1:n]])
  abline(v=0)
}

displayOUprocess(tree2,opt,reg[,1],y1[,1])  # Trait evolve neutrally,
displayOUprocess(tree2,opt,reg[,1],y2[,1])  # under weak selection,
displayOUprocess(tree2,opt,reg[,1],y3[,1])  # under strong selection.

x &lt;- Phylo2DirectedGraph(tree2)
y4 &lt;- TraitVarGraphSim(x, variance = OUvar, p=10, a=5)

DisplayTreeEvol &lt;- function(tp,mvalue) {
  layout(matrix(1:2,1,2))
  n &lt;- length(tp$tip.label)
  ape::plot.phylo(tp,show.tip.label = TRUE, show.node.label = TRUE,
                  root.edge = FALSE, direction = "rightwards", adj = 0)
  plot(y=1:n, x=mvalue[1:n], type="b", xlim=c(-5,5), ylab="",
       xlab="Trait value", yaxt="n", pch=21)
  abline(v=0)
}

## Iteratively displays the simulated traits.
## Left-click on the display area to go to the next plot.
## To terminate: right-click (WIndows, X11), esc key (Mac), or hit the
## "finish" button (RStudio).

for(i in 1:10) {
  DisplayTreeEvol(tree2,y4[i,])
  if(is.null(locator(1)))
    break  ## Terminate: 
}

</code></pre>


</div>