<div class="container">

<table style="width: 100%;"><tr>
<td>mhglm</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Fitting Moment Hierarchical Generalized Linear Models
</h2>

<h3>Description</h3>

<p><code>mhglm</code> is used to fit a moment hierarchical generalized linear model of one level.
<code>mhglm_ml</code> is used to fit a moment hierarchical generalized linear model of arbitrary number of levels 
(including one level).
</p>


<h3>Usage</h3>

<pre><code class="language-R">mhglm(formula, family = gaussian, data, weights, subset,
      na.action, start = NULL, etastart, mustart, offset,
      control = list(), model = TRUE, method = "mhglm.fit",
      x = FALSE, z = FALSE, y = TRUE, group = TRUE,
      contrasts = NULL)

mhglm.fit(x, z, y, group, weights = rep(1, nobs),
          start = NULL, etastart = NULL, mustart = NULL,
          offset = rep(0, nobs), family = gaussian(), 
          control = list(), intercept = TRUE, dispersion = NULL)

mhglm_ml(formula, family = gaussian, data, weights, subset,
         na.action, start = NULL, etastart, mustart, offset,
         control = list(), model = TRUE, method = "mhglm_ml.fit",
         x = FALSE, z = FALSE, y = TRUE, group = TRUE,
         contrasts = NULL)

mhglm_ml.fit(x, z, y, group, weights = rep(1, nobs),
             start = NULL, etastart = NULL, mustart = NULL,
             offset = rep(0, nobs), family = gaussian(), 
             control = list(), intercept = TRUE)

</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula, family, data, weights, subset, na.action, start, etastart,
mustart, offset, model, contrasts, intercept</code></td>
<td>
<p>These arguments
are analogous to the similarly-named arguments for the <code>glm</code> and
<code>glm.fit</code> functions.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>a list of parameters for controlling the fitting
process.  For <code>mhglm.fit</code> this is passed to
<code>mhglm.control</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>the method to be used in fitting the model.  The default
method <code>"mhglm.fit"</code> uses moment-based estimates;
the alternative <code>"model.frame"</code> returns the model frame
and does no fitting.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x, z, y, group</code></td>
<td>
<p> For <code>mhglm</code> and <code>mhglm_ml</code>:
logical values indicating whether the response vector, model matrices,
and grouping factor used in the fitting process should be returned as
components of the returned value.
</p>
<p>For <code>mhglm.fit</code>: <code>x</code> is a fixed effect design matrix of
dimension <code>n * p</code>, <code>z</code> is a random effect design matrix of
dimension <code>n * q</code>, <code>y</code> is a vector of observations of length
<code>n</code>, and <code>group</code> is a grouping factor vector of length
<code>n</code>.
</p>
<p>For <code>mhglm_ml.fit</code>: <code>x</code> is a fixed effect design matrix of
dimension <code>n * p</code>, <code>z</code> is a list of L elements, with L
the depth of nested hierarchies, each element of <code>z</code> 
is a random effect design matrix of dimension <code>n * q_i</code>, with
q_i the feature dimension on tree depth i, 
<code>y</code> is a vector of observations of length <code>n</code>, 
and <code>group</code> is a list of L elements (same L as <code>z</code>), 
each element of <code>group</code> is a grouping factor vector of length <code>n</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dispersion</code></td>
<td>
<p>If <code>NULL</code>, will estimate from data; otherwise use this argument as 
dispersion parameter.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>These functions are analogues of <code>glm</code> and
<code>glm.fit</code>, meant to be used for fitting hierarchical
generalized linear models.  A typical predictor has the form
<code>response ~ terms + (reterms | group)</code> where
<code>response</code> is the (numeric) response vector, <code>terms</code> is a
series of terms which specifies a linear predictor for
<code>response</code>, <code>reterms</code> is a series of terms with random
coefficients (effects), and <code>group</code> is a grouping factor; observations
with the same grouping factor share the same random effects.
</p>
<p><code>mhglm</code> and <code>mhglm.fit</code> only allow one random effect term,
along with a single level of hierarchy. 
<code>mghlm_ml</code> and <code>mhglm_ml.fit</code> allow multiple random effect terms so 
long as levels of random effects are hierarchically nested. If the random 
effect design matrices are the same for each level, a predictor has the form
<code>response ~ terms + (reterms | g1/.../gQ)</code>. If the random effects design
matrices differ from level to level, colons are used to delineate the nesting
structure; for example, 
<code>response ~ fe + (re1 | g1) + (re2 | g2:g1) + (re3 | g3:g2:g1)</code>.
</p>
<p><code>mhglm</code> allows <code>||</code> in the formula
<code>response ~ terms + (reterms || group)</code> to indicate that random effects
are independent, that is the random effects covariance matrix has non-zero 
value only on its diagonal.
<code>mhglm_ml</code> currently does not support <code>||</code>, to indicate indpenedent
random effects, set <code>control=list(diagcov = TRUE)</code>.
</p>


<h3>Value</h3>

<p><code>mhglm</code> returns an object of class inheriting from <code>"mhglm"</code>.
<code>mhglm_ml</code> returns an object of class inheriting from <code>"mhglm_ml"</code>.
</p>
<p>The function <code>summary</code> can be used to obtain or print a summary
of the results.
</p>
<p>The generic accessor functions <code>fixef</code>, <code>ranef</code>,
<code>VarCorr</code>, <code>sigma</code>, <code>fitted.values</code> and
<code>residuals</code> can be used to extract various useful features of the
value returned by <code>mhglm</code> or <code>mhglm_ml</code>.
</p>


<h3>Note</h3>

<p>If the moment-based random effect covariance is not positive-semidefinite, then
a warning will be issued, and a projection of the estimate to the
positive-semidefinite cone will be used instead.
</p>


<h3>References</h3>

<p>P. O. Perry (2017)
"Fast moment-based estimation for hierarchical models."
</p>
<p>N. Zhang, K. Schmaus, and P. O. Perry (2018)
"Fitting deeply-nested hierarchical models to a large book review dataset using moment-based estimators."
</p>


<h3>See Also</h3>

<p><code>terms.mhglm</code>, <code>model.matrix.mhglm</code>, and
<code>predict.mhglm</code> for <code>mhglm</code> methods, and the
generic functions <code>fitted.values</code>, <code>residuals</code>,
<code>summary</code>, <code>vcov</code>, and <code>weights</code>.
</p>
<p>Generic functions <code>fixef</code>, <code>ranef</code>,
<code>VarCorr</code>, and <code>sigma</code> for features
related to mixed effect models.
</p>
<p><code>glmer</code> (package <a href="https://CRAN.R-project.org/package=lme4"><span class="pkg">lme4</span></a>) for
fitting generalized linear mixed models with likelihood-based estimates.
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(lme4)
## The following examples are adapted from lme4:
(fm1 &lt;- mhglm(Reaction ~ Days + (Days | Subject), gaussian, sleepstudy))

(fm2 &lt;- mhglm(Reaction ~ Days + (Days || Subject), gaussian, sleepstudy))

(gm &lt;- mhglm(cbind(incidence, size - incidence) ~ period + (1 | herd),
             data = cbpp, family = binomial))

## The following examples are for multilevel models
g_data &lt;- mhglm_sim(n = 30, m_per_level = c(10, 5, 2), sd_intercept = c(1, 1, 1),
                    sd_slope = c(1, 1, 1), family = "gaussian", seed = 12345)

(m1 &lt;- mhglm_ml(y ~ 1 + x + (1 + x | g1/g2/g3), gaussian, g_data))
# or equivalent
(m2 &lt;- mhglm_ml(y ~ 1 + x + (1 + x | g1) + (1 + x | g2:g1) + (1 + x | g3:g2:g1),
                gaussian, g_data))
</code></pre>


</div>