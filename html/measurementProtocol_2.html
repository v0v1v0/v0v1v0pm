<div class="container">

<table style="width: 100%;"><tr>
<td>mp_send</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Make a Measurement Protocol v2 request</h2>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt="[Experimental]"></a>
Create a server side call to Google Analytics 4 via its Measurement Protocol
</p>
<p>Use mp_connection to set up the Measurement Protocol connections to pass to mp_send.  If using Google Tag Manager Server-Side, you can also set up a custom endpoint.
</p>


<h3>Usage</h3>

<pre><code class="language-R">mp_send(
  events,
  client_id,
  connection,
  user_id = NULL,
  debug_call = FALSE,
  timestamp_micros = NULL,
  user_properties = NULL,
  non_personalized_ads = TRUE
)

mp_connection(
  measurement_id,
  api_secret = Sys.getenv("MP_SECRET"),
  endpoint = NULL,
  preview_header = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>events</code></td>
<td>
<p>The events to send</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>client_id</code></td>
<td>
<p>The client_id to associate with the event</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>connection</code></td>
<td>
<p>The connection details created by mp_connection</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>user_id</code></td>
<td>
<p>Optional. Unique id for the user</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>debug_call</code></td>
<td>
<p>Send hits to the Google debug endpoint to validate hits.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timestamp_micros</code></td>
<td>
<p>Optional. A Unix timestamp (in microseconds) for the time to associate with the event.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>user_properties</code></td>
<td>
<p>Optional. The user properties for the measurement sent in as a named list.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>non_personalized_ads</code></td>
<td>
<p>Optional. Set to true to indicate these events should not be used for personalized ads.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>measurement_id</code></td>
<td>
<p>The measurement ID associated with a stream</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>api_secret</code></td>
<td>
<p>The secret generated in the GA4 UI - by default will look for environment arg <code>MP_SECRET</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>endpoint</code></td>
<td>
<p>If NULL will use Google default, otherwise set to the URL of your Measurement Protocol custom endpoint</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>preview_header</code></td>
<td>
<p>Only needed for custom endpoints. The <code>X-Gtm-Server-Preview</code> HTTP Header found in your GTM debugger</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Create an API secret via <code style="white-space: pre;">⁠Admin &gt; Data Streams &gt; choose your stream &gt; Measurement Protocol &gt; Create⁠</code>
</p>
<p>To see event parameters, create custom fields in your GA4 account first, to see them in your reports 24hrs after you send them in with this function via <code style="white-space: pre;">⁠Custom definitions &gt; Create custom dimensions⁠</code> - <code style="white-space: pre;">⁠dimension name⁠</code> will be how it looks like in the reports, <code style="white-space: pre;">⁠event parameter⁠</code> will be the parameter you have sent in with the event.
</p>
<p><code>user_id</code> can be used for <a href="https://support.google.com/analytics/answer/9213390">cross-platform analysis</a>
</p>
<p><code>timestamp_micros</code> should only be set to record events that happened in the past. This value can be overridden via user_property or event timestamps. Events can be backdated up to 48 hours. Note microseconds, not milliseconds.
</p>
<p><code>user_properties</code> - describe segments of your user base, such as language preference or geographic location.  See <a href="https://developers.google.com/analytics/devguides/collection/protocol/ga4/user-properties?client_type=gtag">User properties</a>
</p>
<p>Ensure you also have user permission as specified in the <a href="https://developers.google.com/analytics/devguides/collection/protocol/ga4/policy">feature policy</a>
</p>
<p>Invalid events are silently rejected with a 204 response, so use <code>debug_call=TRUE</code> to validate your events first.
</p>


<h3>Value</h3>

<p><code>TRUE</code> if successfully sent the hit.  If <code>debug_call=TRUE</code> then the JSON response from the debugger endpoint
</p>
<p><code>TRUE</code> if successful, if <code>debug_call=TRUE</code> then validation messages if not a valid hit.
</p>
<p>An <code>mp_connection</code> class object
</p>


<h3>See Also</h3>

<p><a href="https://developers.google.com/analytics/devguides/collection/protocol/ga4">Measurement Protocol (Google Analytics 4)</a>
</p>
<p>Other Measurement Protocol functions: 
<code>mp_cid()</code>,
<code>mp_event_item()</code>,
<code>mp_event()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R"># preferably set this in .Renviron
Sys.setenv(MP_SECRET="MY_SECRET")

# your GA4 settings
my_measurement_id &lt;- "G-1234"

my_connection &lt;- mp_connection(my_measurement_id)

a_client_id &lt;- 123.456
event &lt;- mp_event("an_event")
mp_send(event, a_client_id, my_connection, debug_call = TRUE)

# multiple events at same time in a batch
another &lt;- mp_event("another_event")

mp_send(list(event, another),
           a_client_id,
           my_connection,
           debug_call = TRUE)
## Not run: 
# you can see sent events in the real-time reports
library(googleAnalyticsR)
my_property_id &lt;- 206670707
ga_data(my_property_id,
        dimensions = "eventName",
        metrics = "eventCount",
        dim_filters = ga_data_filter(
           eventName == c("an_event","another_event")),
        realtime = TRUE)


## End(Not run)

# custom GTM server side endpoint
my_custom_connection &lt;- mp_connection(
   my_measurement_id,
   endpoint = "https://gtm.example.com",
   preview_header = "ZW52LTV8OWdPOExNWFkYjA0Njk4NmQ="
 )

</code></pre>


</div>