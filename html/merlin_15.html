<div class="container">

<table style="width: 100%;"><tr>
<td>merlin</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>merlin - Mixed Effects Regression for Linear, Nonlinear and User-defined models</h2>

<h3>Description</h3>

<p>merlin fits linear, non-linear and user-defined mixed effects regression models. merlin can fit
multivariate outcome models of any type, each of which could be repeatedly measured
(longitudinal), with any number of levels, and with any number of random effects at each level.
Standard distributions/models available include the Bernoulli, Gaussian, Poisson, beta,
negative-binomial, and time-to-event/survival models include the exponential, Gompertz,
Weibull, Royston-Parmar, and general hazard model. merlin provides a
flexible predictor syntax, allowing the user to define variables, random effects, spline and
fractional polynomial functions, functions of other outcome models, and any interaction
between each of them. Non-linear and time-dependent effects are seamlessly incorporated into
the predictor. merlin allows multivariate normal random effects, which are integrated out
using Gaussian quadrature or Monte-Carlo integration. Relative survival (excess hazard) models
are supported. Utility functions are provided to allow user-defined models to be specified,
in conjunction with the complex predictor.
</p>


<h3>Usage</h3>

<pre><code class="language-R">merlin(
  model,
  from = NULL,
  family = "gaussian",
  link = NULL,
  timevar = NULL,
  covariance = "diagonal",
  data,
  userf = NULL,
  sweights = NULL,
  levels = NULL,
  predict = FALSE,
  predtype = NULL,
  predmodel = NULL,
  causes = NULL,
  at = NULL,
  contrast = NULL,
  modelfit = NULL,
  control = list()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>specify the fixed and random elements for each model outcome.
Where there are multiple outcomes, the models should be specified in a list.
Each model should be specified as a formula (e.g. <code>y~x</code>).
A number of different element types can be specified, including
</p>

<ul>
<li>
<p> varname - an independent variable from the data set
</p>
</li>
<li>
<p> random-effects - a random-effect at the cluster level can be specified using <code>M#[cluster level]</code>, for example <code>M1[id]</code> would define a random intercept at the ID level.
Each independent random-effect should be given a unique name, if two random-effects are given the same name they will be treated as shared random-effects.
</p>
</li>
<li> <p><code>rcs()</code> - restricted cubic spline terms, this option can be used to include a restricted cubic spline function, with the degrees of freedom (number of spline terms) specified using the <code>df</code> sub-option, with the boundary knots assumed to be at the minimum and maximum of the variable, with internal knots placed at equally spaced centiles.
Other default options <code>orthog = TRUE</code>, which by default orthogonalises the splines, <code>log = FALSE</code>, which can be used to calculate splines of the log of the variable and <code>event = F</code>, which can be used to calculate the internal knots based only on observations that experienced the event of interest (for survival models).
</p>
</li>
<li> <p><code>srcs()</code> is a shorthand element, equivalent to <code>rcs(..., log = TRUE, event = TRUE)</code>, for use with survival models.
</p>
</li>
<li> <p><code>fp()</code> - fractional polynomials of order 1 or 2 can be specified, the sub-option <code>powers</code> is used to specify the powers of the <code>fp</code> model.
</p>
</li>
<li> <p><code>EV[depvar]</code> - the expected value of the response of a submodel.
</p>
</li>
<li> <p><code>dEV[depvar]</code> - the first derivative with respect to time of the expected value of the response of a submodel.
</p>
</li>
<li> <p><code>d2EV[depvar]</code> - the second derivative with respect to time of the expected value of the response of a submodel.
</p>
</li>
<li> <p><code>iEV[depvar]</code> - the integral with respect to time of the expected value of the response of a submodel.
</p>
</li>
<li> <p><code>XB[depvar]</code> - the expected value of the complex predictor of a submodel.
</p>
</li>
<li> <p><code>dXB[depvar]</code> - the first derivative with respect to time of the expected value of the complex predictor of a submodel.
</p>
</li>
<li> <p><code>d2XB[depvar]</code> - the second derivative with respect to time of the expected value of the complex predictor of a submodel.
</p>
</li>
<li> <p><code>iXB[depvar]</code> - the integral with respect to time of the expected value of the complex predictor of a submodel.
</p>
</li>
<li> <p><code>bhazard(varname)</code> - invokes a relative survival (excess hazard) model.
<code>varname</code> specifies the expected hazard rate at the event time.
</p>
</li>
<li> <p><code>exposure(varname)</code> - include <code>log(varname)</code> in the linear predictor, with a coefficient of 1.
For use with <code>family = "poisson"</code>.
</p>
</li>
<li> <p><code>ap(#)</code> - defines the number of ancillary parameters.
Used with <code>family="user"</code>.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>from</code></td>
<td>
<p>this is an optional argument giving the initial values for the full parameter vector, for more details on how to specify the initial estimates see the vignette.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>family</code></td>
<td>
<p>a vector of strings specifying the family for each outcome specified in model.
The currently available models include,
</p>

<ul>
<li> <p><code>gaussian</code> - Gaussian distribution
</p>
</li>
<li> <p><code>bernoulli</code> - Bernoulli distribution
</p>
</li>
<li> <p><code>poisson</code> - Poisson distribution
</p>
</li>
<li> <p><code>beta</code> - Beta distribution
</p>
</li>
<li> <p><code>negbinomial</code> - Negative binomial distribution
</p>
</li>
</ul>
<p>with survival models including,
</p>

<ul>
<li> <p><code>exponential</code> - exponential distribution
</p>
</li>
<li> <p><code>weibull</code> - Weibull distribution
</p>
</li>
<li> <p><code>gompertz</code> - Gompertz distribution
</p>
</li>
<li> <p><code>rp</code> - Royston-Parmar model (complex predictor on the log cumulative hazard scale)
</p>
</li>
<li> <p><code>loghazard</code> - general log hazard model (complex predictor on the log hazard scale)
</p>
</li>
</ul>
<p>and user-defined,
</p>

<ul>
<li> <p><code>user</code> - fit a user-defined model, which should be written using <code>merlin</code>'s utility functions.
The name of your user-defined function should be passed through the <code>userf</code> option.
</p>
</li>
<li> <p><code>null</code> - is a convenience tool to define additional complex predictors, that do not contribute to the log likelihood.
For use with <code>family = "user"</code>.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>link</code></td>
<td>
<p>string vector defining the link functions for each model.
Default is <code>"identity"</code> for all models.
If specified, you must define a link function for all submodels.
Options include <code>"identity"</code>, <code>"log"</code> and <code>"logit"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timevar</code></td>
<td>
<p>specifies the variable which represents time, this is necessary when a function of time is used in the linear predictor of a survival model as it may interact with other elements of the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>covariance</code></td>
<td>
<p>the structure of the variance-covariance matrix can be varied, the default is <code>diagonal</code> where all diagonal elements of the variance-covariance matrix are estimated uniquely, <code>identity</code> assumes all diagonal elements are equal and <code>unstructured</code> estimates all elements of the variance-covariance matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>a data frame containing all variables required for fitting the model.
Can be a <code>tibble</code> object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>userf</code></td>
<td>
<p>string vector defining the name of the user-written functions for each <code>family="user"</code>.
Each function must be in memory and should return the observation level contribution to the log-likelihood.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sweights</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>levels</code></td>
<td>
<p>if the model contains random-effects then a vector giving the order of levels must be specified, from the highest level to the lowest, e.g. <code>levels=c("practice","id")</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predict</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predtype</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predmodel</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>causes</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>at</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>contrast</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelfit</code></td>
<td>
<p>Not documented.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>A list of parameters that control the estimation algorithm.
Generally it should not be modified, unless there are convergence issues.
Possible values are:
</p>

<ul>
<li> <p><code>ip</code> An optional vector of integers specifying the number of integration points to be used when integrating out the random effects.
A different number of <code>ip</code> can be specified for each <code>level</code> (from highest to lowest level).
If only a single number is given then <code>merlin</code> will assume that number of integration points at all levels.
Default is <code>ip = 7</code> for each level using Gauss-Hermite quadrature, or <code>ip = 100</code> for each level using Monte-Carlo integration;
</p>
</li>
<li> <p><code>intmethod</code> The method used for numerically integrating out the random-effects in order to calculate the likelihood for a mixed effects model which includes random effects.
Options include <code>ghermite</code> for non-adaptive Gauss-Hermite quadrature, <code>halton</code> for Monte-Carlo integration using Halton sequences, <code>sobol</code> for Monte-Carlo integration using Sobol sequences, or <code>mc</code> for standard Monte-Carlo integration using normal draws.
The default is <code>ghermite</code>.
Level-specific integration techniques can be specified, for example, with a three level model, we may use Gauss-Hermite quadrature at the highest level, and Monte-Carlo integration with Halton sequences at level 2, using <code>intmethod = c("ghermite","halton")</code>.
</p>
</li>
<li> <p><code>debug</code> Not documented.
</p>
</li>
<li> <p><code>verbose</code> Not documented.
</p>
</li>
<li> <p><code>optim.method</code> The <code>optim</code> method to be used.
Defaults to Nelder-Mead, see optim for available methods.
</p>
</li>
<li> <p><code>maxit</code> The maximum number of iterations for the optimisation routine.
Defaults to 5000.
</p>
</li>
</ul>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Emma C. Martin, Alessandro Gasparini and Michael J. Crowther
</p>


<h3>References</h3>

<p>Crowther MJ. Extended multivariate generalised linear and non-linear mixed effects models. <a href="https://arxiv.org/abs/1710.02223">https://arxiv.org/abs/1710.02223</a>
</p>
<p>Crowther MJ. merlin - a unified framework for data analysis and methods development in Stata. <a href="https://arxiv.org/abs/1806.01615">https://arxiv.org/abs/1806.01615</a>
</p>
<p>Martin EC, Gasparini A, Crowther MJ. merlin - an R package for mixed effects regression of linear, non-linear and user-defined models.
</p>


<h3>See Also</h3>

<p><code>predict.merlin</code>
</p>
<p><code>merlin_util_depvar</code>, <code>merlin_util_timevar</code>,
<code>merlin_util_xzb</code>, <code>merlin_util_xzb_mod</code>
<code>merlin_util_xzb_deriv</code>, <code>merlin_util_xzb_deriv_mod</code>
<code>merlin_util_xzb_deriv2</code>, <code>merlin_util_xzb_deriv2_mod</code>
<code>merlin_util_xzb_integ</code>, <code>merlin_util_xzb_integ_mod</code>
<code>merlin_util_ev</code>, <code>merlin_util_ev_mod</code>
<code>merlin_util_ev_deriv</code>, <code>merlin_util_ev_deriv_mod</code>
<code>merlin_util_ev_deriv2</code>, <code>merlin_util_ev_deriv2_mod</code>
<code>merlin_util_ev_integ</code>, <code>merlin_util_ev_integ_mod</code>
<code>merlin_util_ap</code>, <code>merlin_util_ap_mod</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
library(merlin)
data(pbc.merlin, package = "merlin")

# Linear fixed-effects model
merlin(logb ~ year,
       family = "gaussian",
       data = pbc.merlin)

# Linear mixed-effects model with random intercept and slope at ID level
merlin(logb ~ year + M1[id] * 1 + year:M2[id] * 1,
       family = "gaussian",
       levels = "id",
       data = pbc.merlin)

# Joint longitudinal and survival model with shared random effects
merlin(model = list(logb ~ year + M1[id] * 1,
                    Surv(stime, died) ~ trt + M1[id]),
       family = c("gaussian", "weibull"),
       levels = "id",
       data = pbc.merlin)

# Joint longitudinal and survival model with expected value
merlin(model = list(logb ~ year + M1[id] * 1,
                    Surv(stime, died) ~ trt + EV[logb]),
       family = c("gaussian", "weibull"),
       levels = "id",
       timevar = c("year","stime"),
       data = pbc.merlin)

# Gaussian distribution - implemented as a user-written family
logl_gaussian &lt;- function(gml)
{
  y    &lt;- merlin_util_depvar(gml)
  xzb  &lt;- merlin_util_xzb(gml)
  se   &lt;- exp(merlin_util_ap(gml,1))

  mu   &lt;- (sweep(xzb,1,y,"-"))^2
  logl &lt;- ((-0.5 * log(2*pi) - log(se)) - (mu/(2 * se^2)))
  return(logl)
}

merlin(logb ~ year + ap(1), family = "user", data = pbc.merlin,
                                  userf = "logl_gaussian")

# 3-level Weibull model
merlin(Surv(stime1,dead1) ~ age + M1[id1]*1 + M2[id2]*1,
       levels=c("id1","id2"), family="weibull", data=sim3)

## End(Not run)
</code></pre>


</div>