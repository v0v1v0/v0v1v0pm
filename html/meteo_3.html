<div class="container">

<table style="width: 100%;"><tr>
<td>cv.strk</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>k-fold cross-validation for spatio-temporal regression kriging</h2>

<h3>Description</h3>

<p>k-fold cross-validation function for spatio-temporal regression kriging based on pred.strk. Currently, only spatial (leave-location-out) cross-validation is implemented. Temporal and spatio-temporal cross-validation will be implemented in the future.</p>


<h3>Usage</h3>

<pre><code class="language-R">cv.strk(data,
        obs.col=1,
        data.staid.x.y.z = NULL,
        crs = NA,
        zero.tol=0,
        reg.coef,
        vgm.model,
        sp.nmax=20,
        time.nmax=2,
        type = "LLO",
        k = 5,
        seed = 42,
        folds,
        refit = TRUE,
        output.format = "STFDF",
        parallel.processing = FALSE,
        pp.type = "snowfall",
        cpus=detectCores()-1,
        progress=TRUE,
        ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>STFDF-class, STSDF-class, STIDF-class, sf-class, sftime-class, SpatVector-class or data.frame; Contains target variable (observations) and covariates in space and time used to perform STRK cross validation. If data.frame object, it should have next columns: station ID (staid), longitude (x), latitude (y), 3rd component - time, depth, ... (z) of the observation, observation value (obs), and covariates (cov1, cov2, ...). Covariate names should be the same as in the <code>reg.coef</code> (see below). If covariates are missing, then spatio-temporal ordinary kriging cross validation is performed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>obs.col</code></td>
<td>
<p>numeric or character; Column name or number showing position of the observation column in the <code>data</code>. Default is 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data.staid.x.y.z</code></td>
<td>
<p>numeric or character vector; Positions or names of the station ID (staid), longitude (x), latitude (y) and 3rd component - time, depth (z) columns in data.frame object (e.g. c(1,2,3,4)). If <code>data</code> is sf-class, sftime-class, or SpatVector-class object, <code>data.staid.x.y.z</code> is used to point staid and z position. If <code>data</code> is STFDF-class, STSDF-class, STIDF-class object, <code>data.staid.x.y.z</code> is used to point only staid position. Default is NULL.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>crs</code></td>
<td>
<p>st_crs or crs; Source CRS of <code>data</code>. If <code>data</code> contains crs, <code>crs</code> will not be used. Default is NA.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>zero.tol</code></td>
<td>
<p>numeric; A distance value below (or equal to) which locations are considered as duplicates. Default is 0. See rm.dupl. Duplicates are removed to avoid singular covariance matrices in kriging.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>reg.coef</code></td>
<td>
<p>numeric; Vector of named linear regression coefficients. Names of the coefficients (e.g. "Intercept", "temp_geo", "modis", "dem", "twi") will be used to match appropriate covariates from <code>data</code>. Coefficients for metorological variables (temperature, precipitation, etc.) can be taken from data(tregcoef) or can be specified by the user.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vgm.model</code></td>
<td>
<p>StVariogramModel list; Spatio-temporal variogram of regression residuals (or observations if spatio-temporal ordinary kriging). See vgmST. Spatio-temporal variogram model on residuals for metorological variables (temperature, precipitation, etc.) can be taken from data(tvgms) or can be specified by the user as a vgmST object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sp.nmax</code></td>
<td>
<p>numeric; A number of spatially nearest observations that should be used for kriging predictions. If <code>tiling</code> is TRUE (see below), then is a number of spatially nearest observations that should be used for each tile. Deafult is 20.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time.nmax</code></td>
<td>
<p>numeric; A number of temporally nearest observations that should be used for kriging predictions Deafult is 2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>character; Type of cross-validation: leave-location-out ("LLO"), leave-time-out ("LTO"), and leave-location-time-out ("LLTO"). Default is "LLO". "LTO" and "LLTO" are not implemented yet. Will be in the future.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k</code></td>
<td>
<p>numeric; Number of random folds that will be created with CreateSpacetimeFolds function. Default is 5.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>numeric; Random seed that will be used to generate outer  and inner folds with CreateSpacetimeFolds function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>folds</code></td>
<td>
<p>numeric or character vector or value; Showing folds column (if value) or rows (vector) of <code>data</code> observations used for cross-validation. If missing, will be created with CreateSpacetimeFolds function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>refit</code></td>
<td>
<p>logical; If refit of linear regression trend and spatio-teporal variogram should be performed. Spatio-teporal variogram is fit using <code>vgm.model</code> as desired spatio-temporal model for fit.StVariogram function. Default is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output.format</code></td>
<td>
<p>character; Format of the output, STFDF-class (default), STSDF-class, STIDF-class, data.frame, sf-class, sftime-class, or SpatVector-class.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parallel.processing</code></td>
<td>
<p>logical; If parallel processing is performed. Default is FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pp.type</code></td>
<td>
<p>character; Type (R package) of parallel processing, "snowfall" (default) or "doParallel".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cpus</code></td>
<td>
<p>numeric; Number of processing units. Default is detectCores()-1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>progress</code></td>
<td>
<p>logical; If progress bar is shown. Default is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Further arguments passed to krigeST or pred.strk.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A STFDF-class (default), STSDF-class, STIDF-class, data.frame, sf-class, sftime-class, or SpatVector-class object (depends on <code>output.format</code> argument), with columns:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>obs</code></td>
<td>
<p>Observations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pred</code></td>
<td>
<p>Predictions from cross-validation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>folds</code></td>
<td>
<p>Folds used for cross-validation.</p>
</td>
</tr>
</table>
<p>For accuracy metrics see acc.metric.fun function.
</p>


<h3>Author(s)</h3>

<p>Aleksandar Sekulic <a href="mailto:asekulic@grf.bg.ac.rs">asekulic@grf.bg.ac.rs</a>, Milan Kilibarda <a href="mailto:kili@grf.bg.ac.rs">kili@grf.bg.ac.rs</a></p>


<h3>References</h3>

<p>Kilibarda, M., T. Hengl, G. B. M. Heuvelink, B. Graeler, E. Pebesma, M. Percec Tadic, and B. Bajat (2014), Spatio-temporal interpolation of daily temperatures for global land areas at 1 km resolution, J. Geophys. Res. Atmos., 119, 2294-2313, doi:10.1002/2013JD020803.
</p>


<h3>See Also</h3>

<p><code>acc.metric.fun</code>
<code>pred.strk</code>
<code>tregcoef</code>
<code>tvgms</code>
<code>regdata</code>
<code>meteo2STFDF</code>
<code>tgeom2STFDF</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(sp)
library(spacetime)
library(gstat)
library(plyr)
library(CAST)
library(doParallel)
library(ranger)
# preparing data
data(dtempc) 
data(stations)
data(regdata) # covariates, made by mete2STFDF function

regdata@sp@proj4string &lt;- CRS('+proj=longlat +datum=WGS84')
data(tvgms) # ST variogram models
data(tregcoef) # MLR coefficients

lonmin=18 ;lonmax=22.5 ; latmin=40 ;latmax=46
serbia = point.in.polygon(stations$lon, stations$lat, c(lonmin,lonmax,lonmax,lonmin), 
                          c(latmin,latmin,latmax,latmax))
st = stations[ serbia!=0, ] # stations in Serbia approx.
crs = CRS('+proj=longlat +datum=WGS84')

# create STFDF
stfdf &lt;- meteo2STFDF(obs = dtempc,
                     stations = st,
                     crs = crs)

# Cross-validation for mean temperature for days "2011-07-05" and "2011-07-06" 
# global model is used for regression and variogram

# Overlay observations with covariates
time &lt;- index(stfdf@time)
covariates.df &lt;- as.data.frame(regdata)
names_covar &lt;- names(tregcoef[[1]])[-1]
for (covar in names_covar){
  nrowsp &lt;- length(stfdf@sp)
  regdata@sp=as(regdata@sp,'SpatialPixelsDataFrame')
  ov &lt;- sapply(time, function(i) 
    if (covar %in% names(regdata@data)) {
      if (as.Date(i) %in% as.Date(index(regdata@time))) {
        over(stfdf@sp, as(regdata[, i, covar], 'SpatialPixelsDataFrame'))[, covar]
      } else {
        rep(NA, length(stfdf@sp))
      }
    } else {
      over(stfdf@sp, as(regdata@sp[covar], 'SpatialPixelsDataFrame'))[, covar]
    }
  )
  ov &lt;- as.vector(ov)
  if (all(is.na(ov))) {
    stop(paste('There is no overlay of data with covariates!', sep = ""))
  }
  stfdf@data[covar] &lt;- ov
}

# Remove stations out of covariates
for (covar in names_covar){
  # count NAs per stations
  numNA &lt;- apply(matrix(stfdf@data[,covar],
                        nrow=nrowsp,byrow= FALSE), MARGIN=1,
                 FUN=function(x) sum(is.na(x)))
  rem &lt;- numNA != length(time)
  stfdf &lt;-  stfdf[rem,drop= FALSE]
}

# Remove dates out of covariates
rm.days &lt;- c()
for (t in 1:length(time)) {
  if(sum(complete.cases(stfdf[, t]@data)) == 0) {
    rm.days &lt;- c(rm.days, t)
  }
}
if(!is.null(rm.days)){
  stfdf &lt;- stfdf[,-rm.days]
}

### Example with STFDF and without parallel processing and without refitting of variogram
results &lt;- cv.strk(data = stfdf,
                   obs.col = 1, # "tempc"
                   data.staid.x.y.z = c(1,NA,NA,NA),
                   reg.coef = tregcoef[[1]],
                   vgm.model = tvgms[[1]],
                   sp.nmax = 20,
                   time.nmax = 2,
                   type = "LLO",
                   k = 5,
                   seed = 42,
                   refit = FALSE,
                   progress = TRUE
)


stplot(results[,,"pred"])

summary(results)
# accuracy
acc.metric.fun(results@data$obs, results@data$pred, "R2")
acc.metric.fun(results@data$obs, results@data$pred, "RMSE")
acc.metric.fun(results@data$obs, results@data$pred, "MAE")
acc.metric.fun(results@data$obs, results@data$pred, "CCC")

</code></pre>


</div>