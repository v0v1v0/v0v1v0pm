<div class="container">

<table style="width: 100%;"><tr>
<td>qq.gamViz</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>QQ plots for gam model residuals</h2>

<h3>Description</h3>

<p>Takes a fitted gam object, converted using getViz, and produces QQ plots of its residuals
(conditional on the fitted model coefficients and scale parameter). If the model distributional
assumptions are met then usually these plots should be close to a straight line (although
discrete data can yield marked random departures from this line).
</p>


<h3>Usage</h3>

<pre><code class="language-R">## S3 method for class 'gamViz'
qq(
  o,
  rep = 10,
  level = 0.8,
  method = "auto",
  type = "auto",
  CI = "none",
  worm = FALSE,
  showReps = FALSE,
  sortFun = NULL,
  discrete = NULL,
  ngr = 1000,
  xlim = NULL,
  ylim = NULL,
  a.qqpoi = list(),
  a.ablin = list(),
  a.cipoly = list(),
  a.replin = list(),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>o</code></td>
<td>
<p>an object of class <code>gamViz</code>, the output of a <code>getViz()</code> call.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rep</code></td>
<td>
<p>how many replicate datasets to generate to simulate quantiles of the residual distribution.
Relevant only if <code>method</code> is set to <code>"simul1"</code> or <code>"simul2"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>level</code></td>
<td>
<p>the level of the confidence intervals (e.g. 0.9 means 90% intervals).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>the method used to calculate the QQ-plot and, possibly, the confidence intervals. If set
to (<code>"tunif"</code>) <code>"tnormal"</code> the residuals are transformed to (uniform) normal, for which
analytic expression for the confidence intervals are available. If set to <code>"simul1"</code> or
<code>"simul2"</code> the theoretical QQ-line is constructed by simulating residuals from the model.
Method <code>"simul2"</code> does not produce confidence intervals. If set to <code>"normal"</code> no simulation
or transformation is performed, and a simple normal QQ-plot is produced. If set to <code>"auto"</code> the
method used to produce the QQ-plot is determined automatically.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>the type of residuals to be used. See residuals.gamViz.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CI</code></td>
<td>
<p>the type of confidence intervals to be plotted. If set to <code>"none"</code> they are not added, if
set to <code>"normal"</code> they will be based on the assumption that the theoretical quantile
distribution is Gaussian and if set to <code>"quantile"</code> they will be sample quantiles of simulated
responses from the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>worm</code></td>
<td>
<p>if <code>TRUE</code> a worm-plot (a de-trended QQ-plot) is plotted.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>showReps</code></td>
<td>
<p>if <code>TRUE</code> all the QQ-lines corresponding to the simulated (model-based) QQ-plots.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sortFun</code></td>
<td>
<p>the function to be used for sorting the residuals. If left to <code>NULL</code> it will be set to
<code>function(.x) sort(.x, method = "quick")</code> internally.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>discrete</code></td>
<td>
<p>if <code>TRUE</code> the QQ-plot is discretized into <code>ngr</code> bins before plotting,
in order to save plotting time (when the number of observations is large). If left
to <code>NULL</code>, the discretization is used if there are more than 10^4 observations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ngr</code></td>
<td>
<p>number of bins to be used in the discretization.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xlim</code></td>
<td>
<p>if supplied then this pair of numbers are used as the x limits for the plot.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ylim</code></td>
<td>
<p>if supplied then this pair of numbers are used as the y limits for the plot.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>a.qqpoi</code></td>
<td>
<p>list of arguments to be passed to <code>ggplot2::geom_point</code>, which plots the main QQ-plot.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>a.ablin</code></td>
<td>
<p>list of arguments to be passed to <code>ggplot2::geom_abline</code>, which adds the reference line.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>a.cipoly</code></td>
<td>
<p>list of arguments to be passed to <code>ggplot2::geom_polygon</code>, which add the confidence intervals.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>a.replin</code></td>
<td>
<p>list of arguments to be passed to <code>ggplot2::geom_line</code>, which adds a line for each simulated
QQ-plot.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>currently unused.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Here <code>method = "simul1"</code> corresponds to the algorithm described in section 2.1 of Augustin et al. (2012), which
involves direct simulations of residuals from the models. This requires <code>o$family$rd</code> to be defined.
Setting <code>method = "simul2"</code> results in a cheaper method, described in section 2.2 of Augustin et al. (2012),
which requires <code>o$family$qf</code> to be defined.
</p>


<h3>Value</h3>

<p>An object of class <code>c("qqGam", "plotSmooth", "gg")</code>.
</p>


<h3>References</h3>

<p>Augustin, N.H., Sauleau, E.A. and Wood, S.N., 2012. On quantile quantile plots for generalized linear models.
Computational Statistics &amp; Data Analysis, 56(8), pp.2404-2409.
</p>


<h3>Examples</h3>

<pre><code class="language-R">######## Example: simulate binomial data
library(mgcViz)
set.seed(0)
n.samp &lt;- 400
dat &lt;- gamSim(1,n = n.samp, dist = "binary", scale = .33)
p &lt;- binomial()$linkinv(dat$f) ## binomial p
n &lt;- sample(c(1, 3), n.samp, replace = TRUE) ## binomial n
dat$y &lt;- rbinom(n, n, p)
dat$n &lt;- n
lr.fit &lt;- gam(y/n ~ s(x0) + s(x1) + s(x2) + s(x3)
              , family = binomial, data = dat,
              weights = n, method = "REML")
lr.fit &lt;- getViz(lr.fit)

# Quick QQ-plot of deviance residuals
qq(lr.fit, method = "simul2")

# Same, but changing points share and type of reference list
qq(lr.fit, method = "simul2", 
       a.qqpoi = list("shape" = 1), a.ablin = list("linetype" = 2))

# Simulation based QQ-plot with reference bands 
qq(lr.fit, rep = 100, level = .9, CI = "quantile")

# Simulation based QQ-plot, Pearson resids, all simulations lines shown 
qq(lr.fit, rep = 100, CI = "none", showReps = TRUE, type = "pearson", 
       a.qqpoi = list(shape=19, size = 0.5))

### Now fit the wrong model and check
pif &lt;- gam(y ~ s(x0) + s(x1) + s(x2) + s(x3)
           , family = poisson, data = dat, method = "REML")
pif &lt;- getViz(pif)

qq(pif, method = "simul2")

qq(pif, rep = 100, level = .9, CI = "quantile")

qq(pif, rep = 100, type = "pearson", CI = "none", showReps = TRUE, 
               a.qqpoi = list(shape=19, size = 0.5))

######## Example: binary data model violation so gross that you see a problem 
######## on the QQ plot
y &lt;- c(rep(1, 10), rep(0, 20), rep(1, 40), rep(0, 10), rep(1, 40), rep(0, 40))
x &lt;- 1:160
b &lt;- glm(y ~ x, family = binomial)
class(b) &lt;- c("gamViz", class(b)) # Tricking qq.gamViz to use it on a glm

# Note that the next two are not necessarily similar under gross 
# model violation...
qq(b, method = "simul2")
qq(b, rep = 50, CI = "none", showReps = TRUE)

### alternative model
b &lt;- gam(y ~ s(x, k = 5), family = binomial, method = "ML")
b &lt;- getViz(b)

qq(b, method = "simul2")
qq(b, rep = 50, showReps = TRUE, CI = "none", shape = 19)

## Not run: 
########  "Big Data" example: 
set.seed(0)
n.samp &lt;- 50000
dat &lt;- gamSim(1,n=n.samp,dist="binary",scale=.33)
p &lt;- binomial()$linkinv(dat$f) ## binomial p
n &lt;- sample(c(1,3),n.samp,replace=TRUE) ## binomial n
dat$y &lt;- rbinom(n,n,p)
dat$n &lt;- n
lr.fit &lt;- bam(y/n ~ s(x0) + s(x1) + s(x2) + s(x3)
              , family = binomial, data = dat,
              weights = n, method = "fREML", discrete = TRUE)
lr.fit &lt;- getViz(lr.fit)

# Turning discretization off (on by default for large datasets).
set.seed(414) # Setting the seed because qq.gamViz is doing simulations
o &lt;- qq(lr.fit, rep = 10, method = "simul1", CI = "normal", showReps = TRUE, 
            discrete = F, a.replin = list(alpha = 0.1))
o # This might take some time!

# Using default discretization
set.seed(414)
o &lt;- qq(lr.fit, rep = 10, method = "simul1", CI = "normal", showReps = TRUE, 
            a.replin = list(alpha = 0.1))
o # Much faster plotting!

# Very coarse discretization
set.seed(414)
o &lt;- qq(lr.fit, rep = 10, method = "simul1", CI = "normal", showReps = TRUE,
            ngr = 1e2, a.replin = list(alpha = 0.1), a.qqpoi = list(shape = 19))
o 

# We can also zoom in at no extra costs (most work already done by qq.gamViz)
zoom(o, xlim = c(-0.25, 0.25), showReps = TRUE, discrete = TRUE, a.replin = list(alpha = 0.2))

## End(Not run)

</code></pre>


</div>