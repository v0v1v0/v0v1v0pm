<div class="container">

<table style="width: 100%;"><tr>
<td>pqueue</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>S3 priority queue implementation using C++</h2>

<h3>Description</h3>

<p>This provides a priority queue that is sorted by the priority and entry order. The priority is assumed to be numeric. The events can be of any type. As an extension, events can be cancelled if they satisfy a certain predicate. Note that the inactive events are not removed, rather they are marked as cancelled and will not be available to be popped.
</p>
<p>Based on C++ code. See also the S3 implementation <code>pqueue</code>.
</p>
<p>This event queue is simple and useful for pedagogic purposes.
</p>
<p>Inherit from this class to represent a discrete event simulation. The
API is similar to that for Omnet++, where an <code>init</code> method sets up
the initial events using the <code>scheduleAt(time,event)</code> method, the
messages are handled using the <code>handleMessage(event)</code> method, the
simulation is run using the <code>run</code> method, and the <code>final</code>
method is called at the end of the simulation.
</p>


<h3>Usage</h3>

<pre><code class="language-R">pqueue(lower = TRUE)
</code></pre>


<h3>Arguments</h3>

<table><tr style="vertical-align: top;">
<td><code>lower</code></td>
<td>
<p>boolean to determine whether to give priority to lower values (default=TRUE)
or higher values</p>
</td>
</tr></table>
<h3>Details</h3>

<p>The algorithm for pushing values into the queue is computationally
very simple: simply rank the times using <code>order()</code> and re-order
times and events. This approach is probably of acceptable performance
for smaller queue. A more computationally efficient approach for
pushing into larger queues would be to use a binary search (e.g. using
<code>findInterval()</code>).
</p>
<p>For faster alternatives, see <code>pqueue</code> and <code>PQueueRef</code>.
</p>


<h3>Value</h3>

<p>a list with
</p>

<dl>
<dt>push</dt>
<dd>
<p>function with arguments priority (numeric) and event (SEXP). Pushes an event with a given priority</p>
</dd>
<dt>pop</dt>
<dd>
<p>function to return a list with a priority (numeric) and an event (SEXP). This pops the first active event.</p>
</dd>
<dt>cancel</dt>
<dd>
<p>function that takes a predicate (or R function) for a given event and returns a logical that indicates whether to cancel that event or not. This may cancel some events that will no longer be popped.</p>
</dd>
<dt>empty</dt>
<dd>
<p>function that returns whether the priority queue is empty (or has no active events).</p>
</dd>
<dt>clear</dt>
<dd>
<p>function to clear the priority queue.</p>
</dd>
<dt>ptr</dt>
<dd>
<p>XPtr value</p>
</dd>
</dl>
<h3>Fields</h3>


<dl>
<dt><code>ptr</code></dt>
<dd>
<p>External pointer to the C++ class</p>
</dd>
<dt><code>times</code></dt>
<dd>
<p>vector of times</p>
</dd>
<dt><code>events</code></dt>
<dd>
<p>list of events</p>
</dd>
<dt><code>times</code></dt>
<dd>
<p>vector of times</p>
</dd>
<dt><code>events</code></dt>
<dd>
<p>list of events</p>
</dd>
</dl>
<h3>Methods</h3>


<dl>
<dt><code>cancel(predicate)</code></dt>
<dd>
<p>Method to cancel events that satisfy some predicate</p>
</dd>
<dt><code>clear()</code></dt>
<dd>
<p>Method to clear the event queue</p>
</dd>
<dt><code>empty()</code></dt>
<dd>
<p>Method to check whether there are no events in the queue</p>
</dd>
<dt><code>initialize(lower = TRUE)</code></dt>
<dd>
<p>Method to initialize the object. lower argument indicates whether lowest priority or highest priority</p>
</dd>
<dt><code>pop()</code></dt>
<dd>
<p>Method to remove the head of the event queue and return its value</p>
</dd>
<dt><code>push(priority, event)</code></dt>
<dd>
<p>Method to push an event with a given priority</p>
</dd>
<dt><code>cancel(predicate, ...)</code></dt>
<dd>
<p>Method to remove events that satisfy some predicate</p>
</dd>
<dt><code>clear()</code></dt>
<dd>
<p>Method to clear the event queue</p>
</dd>
<dt><code>empty()</code></dt>
<dd>
<p>Method to check whether there are no events in the queue</p>
</dd>
<dt><code>pop()</code></dt>
<dd>
<p>Method to remove the head of the event queue and return its value</p>
</dd>
<dt><code>push(time, event)</code></dt>
<dd>
<p>Method to insert the event at the given time</p>
</dd>
<dt><code>final()</code></dt>
<dd>
<p>Method for finalising the simulation</p>
</dd>
<dt><code>handleMessage(event)</code></dt>
<dd>
<p>Virtual method to handle the messages as they arrive</p>
</dd>
<dt><code>init()</code></dt>
<dd>
<p>Virtual method to initialise the event queue and attributes</p>
</dd>
<dt><code>reset(startTime = 0)</code></dt>
<dd>
<p>Method to reset the event queue</p>
</dd>
<dt><code>run(startTime = 0)</code></dt>
<dd>
<p>Method to run the simulation</p>
</dd>
<dt><code>scheduleAt(time, event)</code></dt>
<dd>
<p>Method that adds attributes for the event time and the sendingTime, and then insert the event into the event queue</p>
</dd>
</dl>
<h3>Examples</h3>

<pre><code class="language-R">pq = pqueue()
pq$push(3,"Clear drains")
pq$push(4, "Feed cat")
pq$push(5, "Make tea")
pq$push(1, "Solve RC tasks")
pq$push(2, "Tax return")
while(!pq$empty())
  print(pq$pop())

pq = new("PQueueRef")
pq$push(3,"Clear drains")
pq$push(4, "Feed cat")
pq$push(5, "Make tea")
pq$push(1, "Solve RC tasks")
pq$push(2, "Tax return")
while(!pq$empty())
  print(pq$pop())

pq = new("EventQueue")
pq$push(3,"Clear drains")
pq$push(4, "Feed cat")
pq$push(5, "Make tea")
pq$push(1, "Solve RC tasks")
pq$push(2, "Tax return")
while(!pq$empty())
  print(pq$pop())

DES = setRefClass("DES",
                  contains = "BaseDiscreteEventSimulation",
                  methods=list(
                      init=function() {
                         scheduleAt(3,"Clear drains")
                         scheduleAt(4, "Feed cat")
                         scheduleAt(5, "Make tea")
                         scheduleAt(1, "Solve RC tasks")
                         scheduleAt(2, "Tax return")
                      },
                      handleMessage=function(event) print(event)))

des = new("DES")
des$run()
## Not run: 
testRsimulation1 &lt;- function() {
    ## A simple example
    Simulation &lt;-
        setRefClass("Simulation",
                    contains = "BaseDiscreteEventSimulation")
    Simulation$methods(
        init = function() {
            scheduleAt(rweibull(1,8,85), "Death due to other causes")
            scheduleAt(rweibull(1,3,90), "Cancer diagnosis")
        },
        handleMessage = function(event) {
            if (event %in% c("Death due to other causes", "Cancer death")) {
                clear()
                print(event)
            }
            else if (event == "Cancer diagnosis") {
                if (runif(1) &lt; 0.5)
                    scheduleAt(now() + rweibull(1,2,10), "Cancer death")
                print(event)
            }
        })
    Simulation$new()$run()
}

## An extension with individual life histories
testRsimulation2 &lt;- function(n=100) {
    Simulation &lt;-
        setRefClass("Simulation",
                    contains = "BaseDiscreteEventSimulation",
                    fields = list(state = "character", report = "data.frame"))
    Simulation$methods(
        init = function() {
            report &lt;&lt;- data.frame()
            state &lt;&lt;- "Healthy"
            scheduleAt(rweibull(1,8,85), "Death due to other causes")
            scheduleAt(rweibull(1,3,90), "Cancer diagnosis")
        },
        handleMessage = function(event) {
            report &lt;&lt;- rbind(report, data.frame(state = state,
                                                begin = attr(event,"sendingTime"),
                                                end = currentTime,
                                                event = event,
                                                stringsAsFactors = FALSE))
            if (event %in% c("Death due to other causes", "Cancer death")) {
                clear()
            }
            else if (event == "Cancer diagnosis") {
                state &lt;&lt;- "Cancer"
                if (runif(1) &lt; 0.5)
                    scheduleAt(now() + rweibull(1,2,10), "Cancer death")
            }
        },
        final = function() report)
    sim &lt;- Simulation$new()
    do.call("rbind", lapply(1:n, function(id) data.frame(id=id,sim$run())))
}

## reversible illness-death model
testRsimulation3 &lt;- function(n=100) {
    Simulation &lt;-
        setRefClass("Simulation",
                    contains = "BaseDiscreteEventSimulation",
                    fields = list(state = "character", everCancer = "logical",
                                  report = "data.frame"))
    Simulation$methods(
        init = function() {
            report &lt;&lt;- data.frame()
            state &lt;&lt;- "Healthy"
            everCancer &lt;&lt;- FALSE
            scheduleAt(rweibull(1,8,85), "Death due to other causes")
            scheduleAt(rweibull(1,3,90), "Cancer diagnosis")
        },
        handleMessage = function(event) {
            report &lt;&lt;- rbind(report, data.frame(state = state,
                                                everCancer = everCancer,
                                                begin = attr(event,"sendingTime"),
                                                end = currentTime,
                                                event = event,
                                                stringsAsFactors = FALSE))
            if (event %in% c("Death due to other causes", "Cancer death")) {
                clear()
            }
            else if (event == "Cancer diagnosis") {
                state &lt;&lt;- "Cancer"
                everCancer &lt;&lt;- TRUE
                if (runif(1) &lt; 0.5)
                    scheduleAt(now() + rweibull(1,2,10), "Cancer death")
                scheduleAt(now() + 10, "Recovery")
            }
            else if (event == "Recovery") {
                state &lt;&lt;- "Healthy"
                scheduleAt(now() + rexp(1,10), "Cancer diagnosis")
            }
        },
        final = function() report)
    sim &lt;- Simulation$new()
    do.call("rbind", lapply(1:n, function(id) data.frame(id=id,sim$run())))
}

## cancer screening
testRsimulation4 &lt;- function(n=1) {
    Simulation &lt;-
        setRefClass("Simulation",
                    contains = "BaseDiscreteEventSimulation",
                    fields = list(state = "character", report = "data.frame"))
    Simulation$methods(
        init = function() {
            report &lt;&lt;- data.frame()
            state &lt;&lt;- "Healthy"
            scheduleAt(rweibull(1,8,85), "Death due to other causes")
            scheduleAt(rweibull(1,3,90), "Cancer onset")
            scheduleAt(50,"Screening")
        },
        handleMessage = function(event) {
            report &lt;&lt;- rbind(report, data.frame(state = state,
                                                begin = attr(event,"sendingTime"),
                                                end = currentTime,
                                                event = event,
                                                stringsAsFactors = FALSE))
            if (event %in% c("Death due to other causes", "Cancer death")) {
                clear()
            }
            else if (event == "Cancer onset") {
                state &lt;&lt;- event
                dx &lt;- now() + rweibull(1,2,10)
                scheduleAt(dx, "Clinical cancer diagnosis")
                scheduleAt(dx + rweibull(1,1,10), "Cancer death")
                scheduleAt(now() + rweibull(1,1,10), "Metastatic cancer")
            }
            else if (event == "Metastatic cancer") {
                state &lt;&lt;- event
                cancel(function(event) event %in%
                       c("Clinical cancer diagnosis","Cancer death")) # competing events
                scheduleAt(now() + rweibull(1,2,5), "Cancer death")
            }
            else if (event == "Clinical cancer diagnosis") {
                state &lt;&lt;- event
                cancel(function(event) event == "Metastatic cancer")
            }
            else if (event == "Screening") {
                switch(state,
                       "Cancer onset" = {
                           state &lt;&lt;- "Screen-detected cancer diagnosis"
                           cancel(function(event) event %in%
                                  c("Clinical cancer diagnosis","Metastatic cancer"))
                       },
                       "Metastatic cancer" = {}, # ignore
                       "Clincal cancer diagnosis" = {}, # ignore
                       "Healthy" = {
                           if (now()&lt;=68) scheduleAt(now()+2, "Screening")
                       })
            }
            else stop(event)
        },
        final = function() report)
    sim &lt;- Simulation$new()
    do.call("rbind", lapply(1:n, function(id) data.frame(id=id,sim$run())))
}

## ticking bomb - toy example
testRsimulation5 &lt;- function(n=1) {
    Simulation &lt;-
        setRefClass("Simulation",
                    contains = "BaseDiscreteEventSimulation",
                    fields = list(report = "data.frame"))
    Simulation$methods(
        init = function() {
            report &lt;&lt;- data.frame()
            scheduleAt(rexp(1,1), "tick")
            if (runif(1)&lt;0.1)
                scheduleAt(rexp(1,1), "explosion")
        },
        handleMessage = function(event) {
            report &lt;&lt;- rbind(report, data.frame(begin = attr(event,"sendingTime"),
                                                end = currentTime,
                                                event = event,
                                                stringsAsFactors = FALSE))
            if (event == "explosion")
                clear()
            else {
                clear() # queue
                if (event == "tick") scheduleAt(currentTime+rexp(1,1), "tock")
                else scheduleAt(currentTime+rexp(1,1), "tick")
                if (runif(1)&lt;0.1)
                    scheduleAt(currentTime+rexp(1,1), "explosion")
            }
        },
        final = function() report)
    sim &lt;- Simulation$new()
    do.call("rbind", lapply(1:n, function(id) data.frame(id=id,sim$run())))
}

## End(Not run)

</code></pre>


</div>