<div class="container">

<table style="width: 100%;"><tr>
<td>run_ml</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Run the machine learning pipeline</h2>

<h3>Description</h3>

<p>This function splits the data set into a train &amp; test set,
trains machine learning (ML) models using k-fold cross-validation,
evaluates the best model on the held-out test set,
and optionally calculates feature importance using the framework
outlined in Topçuoğlu <em>et al.</em> 2020 (<a href="https://doi.org/10.1128/mBio.00434-20">doi:10.1128/mBio.00434-20</a>).
Required inputs are a data frame (must contain an outcome variable and all
other columns as features) and the ML method.
See <code>vignette('introduction')</code> for more details.
</p>


<h3>Usage</h3>

<pre><code class="language-R">run_ml(
  dataset,
  method,
  outcome_colname = NULL,
  hyperparameters = NULL,
  find_feature_importance = FALSE,
  calculate_performance = TRUE,
  kfold = 5,
  cv_times = 100,
  cross_val = NULL,
  training_frac = 0.8,
  perf_metric_function = NULL,
  perf_metric_name = NULL,
  groups = NULL,
  group_partitions = NULL,
  corr_thresh = 1,
  seed = NA,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>dataset</code></td>
<td>
<p>Data frame with an outcome variable and other columns as features.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>ML method.
Options: <code>c("glmnet", "rf", "rpart2", "svmRadial", "xgbTree")</code>.
</p>

<ul>
<li>
<p> glmnet: linear, logistic, or multiclass regression
</p>
</li>
<li>
<p> rf: random forest
</p>
</li>
<li>
<p> rpart2: decision tree
</p>
</li>
<li>
<p> svmRadial: support vector machine
</p>
</li>
<li>
<p> xgbTree: xgboost
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcome_colname</code></td>
<td>
<p>Column name as a string of the outcome variable
(default <code>NULL</code>; the first column will be chosen automatically).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hyperparameters</code></td>
<td>
<p>Dataframe of hyperparameters
(default <code>NULL</code>; sensible defaults will be chosen automatically).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>find_feature_importance</code></td>
<td>
<p>Run permutation importance (default: <code>FALSE</code>).
<code>TRUE</code> is recommended if you would like to identify features important for
predicting your outcome, but it is resource-intensive.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>calculate_performance</code></td>
<td>
<p>Whether to calculate performance metrics (default: <code>TRUE</code>).
You might choose to skip this if you do not perform cross-validation during model training.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>kfold</code></td>
<td>
<p>Fold number for k-fold cross-validation (default: <code>5</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cv_times</code></td>
<td>
<p>Number of cross-validation partitions to create (default: <code>100</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cross_val</code></td>
<td>
<p>a custom cross-validation scheme from <code>caret::trainControl()</code>
(default: <code>NULL</code>, uses <code>kfold</code> cross validation repeated <code>cv_times</code>).
<code>kfold</code> and <code>cv_times</code> are ignored if the user provides a custom cross-validation scheme.
See the <code>caret::trainControl()</code> docs for information on how to use it.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>training_frac</code></td>
<td>
<p>Fraction of data for training set (default: <code>0.8</code>). Rows
from the dataset will be randomly selected for the training set, and all
remaining rows will be used in the testing set. Alternatively, if you
provide a vector of integers, these will be used as the row indices for the
training set. All remaining rows will be used in the testing set.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>perf_metric_function</code></td>
<td>
<p>Function to calculate the performance metric to
be used for cross-validation and test performance. Some functions are
provided by caret (see <code>caret::defaultSummary()</code>).
Defaults: binary classification = <code>twoClassSummary</code>,
multi-class classification = <code>multiClassSummary</code>,
regression = <code>defaultSummary</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>perf_metric_name</code></td>
<td>
<p>The column name from the output of the function
provided to perf_metric_function that is to be used as the performance metric.
Defaults: binary classification = <code>"ROC"</code>,
multi-class classification = <code>"logLoss"</code>,
regression = <code>"RMSE"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>groups</code></td>
<td>
<p>Vector of groups to keep together when splitting the data into
train and test sets. If the number of groups in the training set is larger
than <code>kfold</code>, the groups will also be kept together for cross-validation.
Length matches the number of rows in the dataset (default: <code>NULL</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group_partitions</code></td>
<td>
<p>Specify how to assign <code>groups</code> to the training and
testing partitions (default: <code>NULL</code>). If <code>groups</code> specifies that some
samples belong to group <code>"A"</code> and some belong to group <code>"B"</code>, then setting
<code>group_partitions = list(train = c("A", "B"), test = c("B"))</code> will result
in all samples from group <code>"A"</code> being placed in the training set, some
samples from <code>"B"</code> also in the training set, and the remaining samples from
<code>"B"</code> in the testing set. The partition sizes will be as close to
<code>training_frac</code> as possible. If the number of groups in the training set is
larger than <code>kfold</code>, the groups will also be kept together for
cross-validation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>corr_thresh</code></td>
<td>
<p>For feature importance, group correlations
above or equal to <code>corr_thresh</code> (range <code>0</code> to <code>1</code>; default: <code>1</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>Random seed (default: <code>NA</code>).
Your results will only be reproducible if you set a seed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>All additional arguments are passed on to <code>caret::train()</code>, such as
case weights via the <code>weights</code> argument or <code>ntree</code> for <code>rf</code> models.
See the <code>caret::train()</code> docs for more details.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Named list with results:
</p>

<ul>
<li> <p><code>trained_model</code>: Output of <code>caret::train()</code>, including the best model.
</p>
</li>
<li> <p><code>test_data</code>: Part of the data that was used for testing.
</p>
</li>
<li> <p><code>performance</code>: Data frame of performance metrics. The first column is the
cross-validation performance metric, and the last two columns are the ML
method used and the seed (if one was set), respectively.
All other columns are performance metrics calculated on the test data.
This contains only one row, so you can easily combine performance
data frames from multiple calls to <code>run_ml()</code>
(see <code>vignette("parallel")</code>).
</p>
</li>
<li> <p><code>feature_importance</code>: If feature importances were calculated, a data frame
where each row is a feature or correlated group. The columns are the
performance metric of the permuted data, the difference between the true
performance metric and the performance metric of the permuted data
(true - permuted), the feature name, the ML method,
the performance metric name, and the seed (if provided).
For AUC and RMSE, the higher perf_metric_diff is, the more important that
feature is for predicting the outcome. For log loss, the lower
perf_metric_diff is, the more important that feature is for
predicting the outcome.
</p>
</li>
</ul>
<h3>More details</h3>

<p>For more details, please see
<a href="http://www.schlosslab.org/mikropml/articles/">the vignettes</a>.
</p>


<h3>Author(s)</h3>

<p>Begüm Topçuoğlu, <a href="mailto:topcuoglu.begum@gmail.com">topcuoglu.begum@gmail.com</a>
</p>
<p>Zena Lapp, <a href="mailto:zenalapp@umich.edu">zenalapp@umich.edu</a>
</p>
<p>Kelly Sovacool, <a href="mailto:sovacool@umich.edu">sovacool@umich.edu</a>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 

# regression
run_ml(otu_small, "glmnet",
  seed = 2019
)

# random forest w/ feature importance
run_ml(otu_small, "rf",
  outcome_colname = "dx",
  find_feature_importance = TRUE
)

# custom cross validation &amp; hyperparameters
run_ml(otu_mini_bin[, 2:11],
  "glmnet",
  outcome_colname = "Otu00001",
  seed = 2019,
  hyperparameters = list(lambda = c(1e-04), alpha = 0),
  cross_val = caret::trainControl(method = "none"),
  calculate_performance = FALSE
)

## End(Not run)
</code></pre>


</div>