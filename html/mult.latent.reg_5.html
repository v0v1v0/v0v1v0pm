<div class="container">

<table style="width: 100%;"><tr>
<td>mult.em_2level</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>EM algorithm for multivariate two level model with covariates</h2>

<h3>Description</h3>

<p>This function extends the one-level version mult.em_1level,
and it is designed to obtain Maximum Likelihood Estimates (MLE) using the EM algorithm for nested (structured) multivariate data,
e.g. multivariate test scores (such as on numeracy, literacy)  of students nested in different classes or schools.
The resulting estimates can be applied for clustering or constructing league tables (ranking of observations).
With the inclusion of covariates, the model allows fitting a multivariate response model for further regression analysis.
Detailed information about the model used in this function can be found in Zhang et al. (2023).
</p>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A data set object; we denote the dimension to be <code class="reqn">m</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>v</code></td>
<td>
<p>Covariate(s).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>K</code></td>
<td>
<p>Number of mixture components, the default is <code>K = 2</code>. Note that when <code>K = 1</code>, <code>z</code> and <code>beta</code> will be 0.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>steps</code></td>
<td>
<p>Number of iterations, the default is <code>steps = 20</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>start</code></td>
<td>
<p>Containing parameters involved in the proposed model (<code>p</code>, <code>alpha</code>, <code>z</code>, <code>beta</code>, <code>sigma</code>, <code>gamma</code>) in a list,
the starting values can be obtained through the use of start_em. More details can be found in start_em.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>option</code></td>
<td>
<p>Four options for selecting the starting values for the parameters in the model. The default is <code>option = 1</code>.
More details can be found in start_em.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>var_fun</code></td>
<td>
<p>There are two types of variance specifications; <code>var_fun = 1</code>, the same diagonal variance specification to all <code>K</code> components of the mixture;
<code>var_fun = 2</code>, different diagonal variance matrices for different components;
The default is <code>var_fun = 2</code>.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>The estimated parameters in the model <code class="reqn">x_{ij} = \alpha + \beta z_k + \Gamma v_{ij} + \varepsilon_{ij}</code> obtained through the EM algorithm,
where the upper-level unit is indexed by <code class="reqn">i</code>, and the lower-level unit is indexed by <code class="reqn">j</code>.
</p>
<table>
<tr style="vertical-align: top;">
<td><code>p</code></td>
<td>
<p>The estimates for the parameter <code class="reqn">\pi_k</code>, which is a vector of length <code class="reqn">K</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>The estimates for the parameter <code class="reqn">\alpha</code>, which is a vector of length <code class="reqn">m</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>z</code></td>
<td>
<p>The estimates for the parameter <code class="reqn">z_k</code>, which is a vector of length <code class="reqn">K</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>beta</code></td>
<td>
<p>The estimates for the parameter <code class="reqn">\beta</code>, which is a vector of length <code class="reqn">m</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gamma</code></td>
<td>
<p>The estimates for the parameter <code class="reqn">\Gamma</code>, which is a matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sigma</code></td>
<td>
<p>The estimates for the parameter <code class="reqn">\Sigma_k</code>.
When <code>var_fun = 1</code>, <code class="reqn">\Sigma_k</code> is a diagonal matrix and <code class="reqn">\Sigma_k = \Sigma</code>, and we obtain a vector of the diagonal elements;
When <code>var_fun = 2</code>, <code class="reqn">\Sigma_k</code> is a diagonal matrix, and we obtain <code>K</code> vectors of the diagonal elements.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>W</code></td>
<td>
<p>The posterior probability matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loglikelihood</code></td>
<td>
<p>The approximated log-likelihood of the fitted model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>disparity</code></td>
<td>
<p>The disparity (<code>-2logL</code>) of the fitted model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>number_parameters</code></td>
<td>
<p>The number of parameters estimated in the EM algorithm.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>AIC</code></td>
<td>
<p>The AIC value (<code>-2logL + 2number_parameters</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>starting_values</code></td>
<td>
<p>A list of starting values for parameters used in the EM algorithm.</p>
</td>
</tr>
</table>
<h3>References</h3>

<p>Zhang, Y., Einbeck, J. and Drikvandi, R. (2023). A multilevel multivariate response model for data with latent structures.
In: Proceedings of the 37th International Workshop on Statistical Modelling, pages 343-348.
Link on RG: <a href="https://www.researchgate.net/publication/375641972_A_multilevel_multivariate_response_model_for_data_with_latent_structures">https://www.researchgate.net/publication/375641972_A_multilevel_multivariate_response_model_for_data_with_latent_structures</a>
</p>


<h3>See Also</h3>

<p><code>mult.reg_2level</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
##examples for data without covariates.
data(trading_data)
set.seed(49)
trade_res &lt;- mult.em_2level(trading_data, K=4, steps = 10, var_fun = 2)

i_1 &lt;- apply(trade_res$W, 1, which.max)
ind_certain &lt;- rep(as.vector(i_1),c(4,5,5,3,5,5,4,4,5,5,5,5,5,5,5,5,5,5,
3,5,5,5,5,4,4,5,5,5,4,5,4,5,5,5,3,5,5,5,5,5,5,4,5,4))
colors &lt;- c("#FF6600","#66BD63", "lightpink","purple")
plot(trading_data[,-3],pch = 1, col = colors[factor(ind_certain)])
legend("topleft", legend=c("Mass point 1", "Mass point 2","Mass point 3","Mass point 4"),
col=c("#FF6600","purple","#66BD63","lightpink"),pch = 1, cex=0.8)

###The Twins data
library(lme4)
set.seed(26)
twins_res &lt;- mult.em_2level(twins_data[,c(1,2,3)],v=twins_data[,c(4,5,6)],
K=2, steps = 20, var_fun = 2)
coeffs &lt;- twins_res$gamma
##Compare to the estimated coefficients obtained using individual two-level models (lmer()).
summary(lmer(SelfTouchCodable ~ Depression + PSS + Anxiety + (1 | id) ,
data=twins_data, REML = TRUE))$coefficients[2,1]

</code></pre>


</div>