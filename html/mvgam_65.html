<div class="container">

<table style="width: 100%;"><tr>
<td>lfo_cv.mvgam</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Approximate leave-future-out cross-validation of fitted <code>mvgam</code> objects</h2>

<h3>Description</h3>

<p>Approximate leave-future-out cross-validation of fitted <code>mvgam</code> objects
</p>


<h3>Usage</h3>

<pre><code class="language-R">lfo_cv(object, ...)

## S3 method for class 'mvgam'
lfo_cv(
  object,
  data,
  min_t,
  fc_horizon = 1,
  pareto_k_threshold = 0.7,
  silent = 1,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p><code>list</code> object returned from <code>mvgam</code>. See <code>mvgam()</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Ignored</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A <code>dataframe</code> or <code>list</code> containing the model response variable and covariates
required by the GAM <code>formula</code>. Should include columns:
'series' (character or factor index of the series IDs)
'time' (numeric index of the time point for each observation).
Any other variables to be included in the linear predictor of <code>formula</code> must also be present</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>min_t</code></td>
<td>
<p>Integer specifying the minimum training time required before making predictions
from the data. Default is either <code>30</code>, or whatever training time allows for at least
<code>10</code> lfo-cv calculations (i.e. <code>pmin(max(data$time) - 10, 30)</code>). This value is essentially
arbitrary so it is highly recommended to change it to something that is more suitable to the
data and models being evaluated</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fc_horizon</code></td>
<td>
<p>Integer specifying the number of time steps ahead for evaluating forecasts</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pareto_k_threshold</code></td>
<td>
<p>Proportion specifying the threshold over which the Pareto shape parameter
is considered unstable, triggering a model refit. Default is <code>0.7</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>silent</code></td>
<td>
<p>Verbosity level between <code>0</code> and <code>2</code>. If <code>1</code> (the default), most of the informational
messages of compiler and sampler are suppressed. If <code>2</code>, even more messages are suppressed. The
actual sampling progress is still printed. Set <code>refresh = 0</code> to turn this off as well. If using
<code>backend = "rstan"</code> you can also set open_progress = FALSE to prevent opening additional
progress bars.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Approximate leave-future-out cross-validation uses an expanding training window scheme
to evaluate a model on its forecasting ability. The steps used in this function mirror those laid out
in the <a href="https://mc-stan.org/loo/articles/loo2-lfo.html">lfo vignette from the <code>loo</code> package</a>,
written by Paul Bürkner, Jonah Gabry, Aki Vehtari. First, we refit the model using the first <code>min_t</code>
observations to perform a single exact <code>fc_horizon</code>-ahead forecast step. This forecast is evaluated against
the <code>min_t + fc_horizon</code> out of sample observations using the Expected Log Predictive Density (ELPD).
Next, we approximate each successive round of
expanding window forecasts by moving forward one step at a time <code style="white-space: pre;">⁠for i in 1:N_evaluations⁠</code> and re-weighting
draws from the model's posterior predictive distribution using Pareto Smoothed
Importance Sampling (PSIS). In each iteration <code>i</code>, PSIS weights are obtained for the next observation
that would have been included in the model if we had re-fit (i.e. the last observation that would have
been in the training data, or <code>min_t + i</code>). If these importance ratios are stable, we consider the
approximation adequate and use the re-weighted posterior's forecast for evaluating the next holdout
set of testing observations (<code>(min_t + i + 1):(min_t + i + fc_horizon)</code>). At some point the
importance ratio variability will become too large and importance sampling will fail. This is
indicated by the estimated shape parameter <code>k</code> of the generalized Pareto distribution
crossing a certain threshold <code>pareto_k_threshold</code>. Only then do we refit the model using
all of the observations up to the time of the failure. We then restart the process and iterate forward
until the next refit is triggered (Bürkner et al. 2020).
</p>


<h3>Value</h3>

<p>A <code>list</code> of class <code>mvgam_lfo</code> containing the approximate ELPD scores,
the Pareto-k shape values and 'the specified <code>pareto_k_threshold</code>
</p>


<h3>Author(s)</h3>

<p>Nicholas J Clark
</p>


<h3>References</h3>

<p>Paul-Christian Bürkner, Jonah Gabry &amp; Aki Vehtari (2020). Approximate leave-future-out cross-validation for Bayesian time series models
Journal of Statistical Computation and Simulation. 90:14, 2499-2523.
</p>


<h3>See Also</h3>

<p><code>forecast</code>, <code>score</code>, <code>compare_mvgams</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
# Simulate from a Poisson-AR2 model with a seasonal smooth
set.seed(100)
dat &lt;- sim_mvgam(T = 75,
                n_series = 1,
                prop_trend = 0.75,
                trend_model = 'AR2',
                family = poisson())

# Plot the time series
plot_mvgam_series(data = dat$data_train,
                 newdata = dat$data_test,
                 series = 1)

# Fit an appropriate model
mod_ar2 &lt;- mvgam(y ~ s(season, bs = 'cc', k = 6),
               trend_model = AR(p = 2),
               family = poisson(),
               data = dat$data_train,
               newdata = dat$data_test,
               burnin = 300,
               samples = 300,
               chains = 2)

# Fit a less appropriate model
mod_rw &lt;- mvgam(y ~ s(season, bs = 'cc', k = 6),
              trend_model = RW(),
              family = poisson(),
              data = dat$data_train,
              newdata = dat$data_test,
              burnin = 300,
              samples = 300,
              chains = 2)

# Compare Discrete Ranked Probability Scores for the testing period
fc_ar2 &lt;- forecast(mod_ar2)
fc_rw &lt;- forecast(mod_rw)
score_ar2 &lt;- score(fc_ar2, score = 'drps')
score_rw &lt;- score(fc_rw, score = 'drps')
sum(score_ar2$series_1$score)
sum(score_rw$series_1$score)

# Now use approximate leave-future-out CV to compare
# rolling forecasts; start at time point 40 to reduce
# computational time and to ensure enough data is available
# for estimating model parameters
lfo_ar2 &lt;- lfo_cv(mod_ar2,
                 min_t = 40,
                 fc_horizon = 3)
lfo_rw &lt;- lfo_cv(mod_rw,
                min_t = 40,
                fc_horizon = 3)

# Plot Pareto-K values and ELPD estimates
plot(lfo_ar2)
plot(lfo_rw)

# Proportion of timepoints in which AR2 model gives better forecasts
length(which((lfo_ar2$elpds - lfo_rw$elpds) &gt; 0)) /
      length(lfo_ar2$elpds)

# A higher total ELPD is preferred
lfo_ar2$sum_ELPD
lfo_rw$sum_ELPD

## End(Not run)
</code></pre>


</div>