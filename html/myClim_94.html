<div class="container">

<table style="width: 100%;"><tr>
<td>mc_prep_TMSoffsoil</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Detection of out-of-soil measurements from TMS logger</h2>

<h3>Description</h3>

<p>This function creates new virtual sensor labelling anomalies in TMS logger caused by displacement out of from soil.
</p>


<h3>Usage</h3>

<pre><code class="language-R">mc_prep_TMSoffsoil(
  data,
  localities = NULL,
  soil_sensor = mc_const_SENSOR_TMS_T1,
  air_sensor = mc_const_SENSOR_TMS_T2,
  moist_sensor = mc_const_SENSOR_TMS_moist,
  output_sensor = "off_soil",
  smooth = FALSE,
  smooth_window = 10,
  smooth_threshold = 0.5,
  sd_threshold = 0.76085,
  minmoist_threshold = 721.5
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>cleaned myClim object see myClim-package</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>localities</code></td>
<td>
<p>names of localities; if NULL then all (default NULL)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>soil_sensor</code></td>
<td>
<p>character, soil temperature sensor (default <code>mc_const_SENSOR_TMS_T1</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>air_sensor</code></td>
<td>
<p>character, air temperature sensor (default <code>mc_const_SENSOR_TMS_T2</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>moist_sensor</code></td>
<td>
<p>character, soil moisture sensor (default <code>mc_const_SENSOR_TMS_moist</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output_sensor</code></td>
<td>
<p>character, name of virtual sensor to store ouptup values (default "off_soil")</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>smooth</code></td>
<td>
<p>logical, smooth out isolated faulty/correct records using floating window (default FALSE)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>smooth_window</code></td>
<td>
<p>integer, smooth floating window width (in days) (default 10)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>smooth_threshold</code></td>
<td>
<p>numeric, floating window threshold for detection of faulty records. (default 0.5)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sd_threshold</code></td>
<td>
<p>numeric, threshold value for the criteria on the ratio of standard deviation of the soil sensor
to the above-ground sensor temperatures (default 0.76085)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>minmoist_threshold</code></td>
<td>
<p>numeric, threshold value for criteria on the minimum soil moisture (default 721.5)</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>TMS loggers, when correctly installed in the soil, exhibit certain temperature and soil moisture signal characteristics.
Temperature varies the most at the soil interface, and temperature fluctuations in the soil are minimized.
The moisture signal from a sensor that has lost direct contact with the soil is reduced.
The following criteria are used for detecting faulty measurements: the ratio of the standard deviations of the soil
sensor to the above-ground sensor within 24h moving window is greater than the defined threshold (default 0.76085),
and simultaneously, the soil moisture minimum within 24h mowing window is less than 721.5.
Optionally, the prediction results can be smoothed using a floating window to average-out unlikely short periods detected by the algorithm.
Selection and parametrization of criteria was done using a recursive partitioning (rpart::rpart)
on the training set of 7.8M readings in 154 TMS timeseries from different environmental settings (temperate forests, tropical rainforest, cold desert, alpine and subnival zone,
and invalid measurements from loggers stored in the office or displaced from the soil).
Sensitivity of the method (true positive rate) on was 95.1% and specificity (true negative rate) was 99.4% using function default parameters.
Smoothing with 10 day floating window increased sensitivity to 96.8% while retaining specifity at the same level of 99.4%.
Decreasing 'smooth_threshold' below 0.5 will extend periods flagged as faulty measurement.
</p>


<h3>Value</h3>

<p>numeric vector (0 = correct measurement, 1 = faulty measurement) stored as virtual sensor in myClim object
</p>


<h3>Examples</h3>

<pre><code class="language-R">data &lt;- mc_read_files(system.file("extdata", "data_93142760_201904.csv", package = "myClim"),
                      "TOMST")
data &lt;- mc_prep_TMSoffsoil(data)
mc_plot_line(data, sensors = c("off_soil","TMS_T1", "TMS_T2","TMS_T3"))
</code></pre>


</div>